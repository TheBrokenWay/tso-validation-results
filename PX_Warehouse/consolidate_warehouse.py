"""
╔══════════════════════════════════════════════════════════════════════════════╗
║ consolidate_warehouse.py                                                    ║
║ OLYMPUS :: Commercial Asset Manager (Six Pillars Enforcement)               ║
║ ARCHITECT: JAMES A. TILLAR                                                  ║
╚══════════════════════════════════════════════════════════════════════════════╝
"""
import os
import shutil
import json
from datetime import datetime
from pathlib import Path

# --- CONFIGURATION: THE SIX PILLARS (repo-relative) ---
_REPO = Path(__file__).resolve().parents[1]
WAREHOUSE_ROOT = str(_REPO / "PX_Warehouse" / "CommercialAssets")

FOLDERS = {
    "INBOX": os.path.join(WAREHOUSE_ROOT, "Dossier_Final"),       # The Landing Zone
    "GOLD": os.path.join(WAREHOUSE_ROOT, "Gold"),                 # Sellable (High Value)
    "SILVER": os.path.join(WAREHOUSE_ROOT, "Silver"),             # Sellable (Standard)
    "LEARNING": os.path.join(WAREHOUSE_ROOT, "Learning_Material"),# Unsellable/Failed
    "AUDIT": os.path.join(WAREHOUSE_ROOT, "Audit_Trail"),         # Raw Logs (ALCOA+)
    "SUMMARY": os.path.join(WAREHOUSE_ROOT, "Executive_Summary")  # PDF/MD One-Pagers
}

def ensure_architecture():
    """Enforces the physical existence of the Six Pillars."""
    for key, path in FOLDERS.items():
        if not os.path.exists(path):
            os.makedirs(path)
            print(f"  [ARCH] Created Pillar: {key}")

def grade_and_sort_asset(file_path):
    """Reads a Dossier, Grades it, and moves it to the correct Pillar."""
    filename = os.path.basename(file_path)
    
    try:
        with open(file_path, 'r') as f:
            data = json.load(f)
            
        # --- EXTRACTION ---
        # Robustly find metrics (handle different schema versions)
        efficacy = data.get("virtual_efficacy", {})
        responder_rate = efficacy.get("responder_rate", {}).get("response_ratio", 0.0)
        pta = efficacy.get("pk_pta", {}).get("auc_mg_h_per_L", {}).get("pta", 0.0)
        
        # CONSTITUTIONAL HARD-LOCK: Toxicity Check
        admet = data.get("admet", {})
        tox = admet.get("toxicity", {}).get("toxicity_index", 1.0)
        
        # --- GRADING LOGIC ---
        # TRASH: Toxicity index >= 0.0210 MUST be discarded immediately
        if tox >= 0.0210:
            target_folder = FOLDERS["LEARNING"]
            grade = "REJECTED_TRASH"
        # GOLD: High efficacy, commercially viable PTA (>30%), and SAFE (tox < 0.0200)
        elif pta >= 30.0 and responder_rate >= 0.3 and tox < 0.0200:
            target_folder = FOLDERS["GOLD"]
            grade = "GOLD"
        # SILVER: Moderate efficacy, acceptable PTA (>20%), and ACCEPTABLE (tox < 0.0210)
        elif pta >= 20.0 and responder_rate >= 0.2 and tox < 0.0210:
            target_folder = FOLDERS["SILVER"]
            grade = "SILVER"
        # LEARNING: Everything else (Toxic, Low Potency, Failed Runs)
        else:
            target_folder = FOLDERS["LEARNING"]
            grade = "LEARNING"

        # --- EXECUTION ---
        # 1. Move the JSON Dossier
        dest_path = os.path.join(target_folder, filename)
        shutil.move(file_path, dest_path)
        print(f"  [SORT] {filename} -> {grade}")

        # 2. Generate Executive Summary (Markdown)
        generate_summary(data, filename, grade)
        
        return grade

    except Exception as e:
        print(f"  [ERROR] Corrupt Asset {filename}: {str(e)}")
        # Move corrupt files to Learning Material to keep Inbox clean
        shutil.move(file_path, os.path.join(FOLDERS["LEARNING"], f"CORRUPT_{filename}"))

def generate_summary(data, filename, grade):
    """Creates a sell-sheet summary in the Executive_Summary folder."""
    name = data.get("metadata", {}).get("name", "Unknown_Compound")
    smiles = data.get("metadata", {}).get("smiles", "N/A")
    
    summary_text = f"""
    # EXECUTIVE SUMMARY: {name}
    **Grade**: {grade}
    **Date**: {datetime.now().strftime('%Y-%m-%d')}
    
    ## Commercial Profile
    * **Compound**: {name}
    * **SMILES**: `{smiles}`
    * **Classification**: {grade} Tier Asset
    
    ## Virtual Clinical Data
    * **Responder Rate**: {data.get('virtual_efficacy', {}).get('responder_rate', {}).get('response_ratio', 'N/A')}
    * **Target Attainment (PTA)**: {data.get('virtual_efficacy', {}).get('pk_pta', {}).get('auc_mg_h_per_L', {}).get('pta', 'N/A')}%
    * **Safety Margin**: {data.get('dose_optimization', {}).get('safety_margin', 'N/A')}x
    
    ---
    *Generated by OLYMPUS Architecture Enforcement*
    """
    
    summary_path = os.path.join(FOLDERS["SUMMARY"], f"{name}_Summary.md")
    with open(summary_path, "w") as f:
        f.write(summary_text)

def main():
    print("--- ENGAGING OLYMPUS ARCHITECTURE ENFORCEMENT ---")
    ensure_architecture()
    
    # Scan the Landing Zone (Dossier_Final)
    files = [f for f in os.listdir(FOLDERS["INBOX"]) if f.endswith('.json')]
    
    if not files:
        print("  [INFO] No new dossiers in Inbox.")
    else:
        print(f"  [INFO] Processing {len(files)} assets...")
        for f in files:
            grade_and_sort_asset(os.path.join(FOLDERS["INBOX"], f))

    print("--- WAREHOUSE CONSOLIDATED ---")

if __name__ == "__main__":
    main()